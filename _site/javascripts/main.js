// Generated by CoffeeScript 1.8.0
$(window).load(function() {
  var token;
  token = $.url('?token');
  if (token) {
    firebase.auth().signInWithCustomToken(token);
    updateQueryStringParam('token');
  }
  firebase.auth().onAuthStateChanged(function(user) {
    $('#user').empty();
    if (!user) {
      return;
    }
    window.logged_in_user = user;
    firebase.database().ref("posts").on('child_added', function(item) {
      return $('#posts').append(teacup.render(function() {
        return div('.post', function() {
          div('.upvotes', function() {
            return item.upvotes;
          });
          return blockquote(".reddit-card", function() {
            return a({
              href: "" + item.post + "/?ref=share&ref_source=embed"
            });
          });
        });
      }));
    });
    return firebase.database().ref("users/" + user.uid).on('value', function(doc) {
      $('#user').html(teacup.render(function() {
        div('.user', function() {
          return div(function() {
            return "User: " + user.uid;
          });
        });
        div('.post', function() {
          span(function() {
            return 'Reddit Post: ';
          });
          return input({
            value: doc.child('post').val()
          });
        });
        div('.comment', function() {
          span(function() {
            return 'Comment Post: ';
          });
          return input({
            value: doc.child('comment').val()
          });
        });
        return div('.button', function() {
          return 'Submit';
        });
      }));
      return $('#user .button').on('click', function(e) {
        var current_user;
        current_user = doc.val();
        current_user.comment = $('#user .comment input').val();
        current_user.post = $('#user .post input').val();
        return doc.ref.set(current_user, function() {
          return firebase.database().ref("queue").push({
            user: user.uid,
            post: current_user.post
          });
        });
      });
    });
  });
  return $('.reddit-login').on('click', function(e) {
    var k, params, url, v;
    params = ((function() {
      var _ref, _results;
      _ref = {
        client_id: 'Ag0ViT48lPnFiQ',
        response_type: 'code',
        state: '123',
        redirect_uri: 'https://us-central1-botnet-a2e6f.cloudfunctions.net/redditAuth',
        duration: 'permanent',
        scope: 'vote identity'
      };
      _results = [];
      for (k in _ref) {
        v = _ref[k];
        _results.push("" + k + "=" + (encodeURIComponent(v)));
      }
      return _results;
    })()).join('&');
    url = "https://www.reddit.com/api/v1/authorize?" + params;
    return window.open(url);
  });
});
